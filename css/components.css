/* =========================================
   components.css — Layout & Komponenten
   Highest-Level: Robustheit, Konsistenz,
   iOS Safe Area, A11y Focus, weniger Redundanz
   1:1 Replace File
   ========================================= */

@layer tokens, base, components, utilities, overrides;

/* =========================================
   TOKENS — Component-level Fallback Tokens
   - bevorzugt theme.css (semantische Tokens)
   - enthält nur sichere Fallbacks / Aliases
   ========================================= */
@layer tokens {
  :root {
    /* Elevation mapping (prefers theme.css) */
    --elevation-xs: var(--elev-1, 0 1px 2px rgba(15, 23, 42, 0.06));
    --elevation-sm: var(--elev-1, 0 1px 3px rgba(15, 23, 42, 0.12));
    --elevation-md: var(--elev-2, 0 4px 10px rgba(15, 23, 42, 0.16));
    --elevation-lg: var(--elev-3, 0 10px 24px rgba(15, 23, 42, 0.22));

    /* Borders */
    --border-subtle: 1px solid var(--border-2, rgba(148, 163, 184, 0.22));
    --border-soft: 1px solid var(--border-1, rgba(148, 163, 184, 0.16));
    --stroke-1: 1px solid var(--border-1, rgba(148, 163, 184, 0.24));
    --stroke-2: 1px solid var(--border-2, rgba(148, 163, 184, 0.32));

    /* Neutral surfaces derived from semantic surfaces */
    --neutral-0: var(--surface-1, #ffffff);
    --neutral-1: var(--surface-2, #f9fafb);
    --neutral-2: var(--surface-3, #f3f4f6);

    /* Button sizing */
    --btn-height: 38px;
    --btn-radius: var(--radius-pill, 999px);

    /* Motion fallbacks (do not override theme.css tokens) */
    --dur-fast-fallback: 120ms;
    --dur-fallback: 160ms;
    --dur-slow-fallback: 220ms;
    --ease-out-fallback: cubic-bezier(0.2, 0.8, 0.2, 1);

    /* Focus ring fallback (theme.css preferred) */
    --focus-ring-default:
      0 0 0 2px #ffffff,
      0 0 0 4px hsla(var(--accent-h, 28), 72%, 52%, 0.55);

    /* Warm palette fallbacks (component accents only) */
    --fsm-warm-0: #f7e1d0;
    --fsm-warm-1: #e7bf9f;
    --fsm-warm-2: #d49a6a;
    --fsm-warm-3: #c98655;

    --fsm-surface-warm: #f5e3d4;
    --fsm-chip-warm: #f1dfcf;
    --fsm-divider-warm: hsla(28, 24%, 40%, 0.22);

    /* App background fallbacks */
    --app-bg-fallback-light: var(--fsm-warm-0);
    --app-bg-fallback-dark: rgba(2, 6, 23, 0.94);

    /* Chip look (Bild 3) */
    --chip-surface: var(--chip-bg, var(--fsm-chip-warm, #f1dfcf));
    --chip-border: rgba(148, 163, 184, 0.45);
    --chip-border-hover: rgba(148, 163, 184, 0.65);
    --chip-shadow: 0 1px 0 rgba(15, 23, 42, 0.06);
    --chip-shadow-hover: 0 2px 0 rgba(15, 23, 42, 0.08);
    --chip-active-border: hsla(var(--accent-h, 28), 72%, 52%, 0.85);

    /* Tilla shell button color (extracted from screenshot; theme may override) */
    --tilla-shell: #f3831a;
    --tilla-shell-hover: #e17112;
    --tilla-shell-active: #d1630e;
    --on-tilla-shell: #ffffff;
  }

  [data-theme="dark"] {
    --focus-ring-default:
      0 0 0 2px rgba(2, 6, 23, 0.92),
      0 0 0 4px hsla(var(--accent-h, 28), 72%, 55%, 0.45);

    --chip-border: rgba(148, 163, 184, 0.40);
    --chip-border-hover: rgba(148, 163, 184, 0.55);
    --chip-shadow: 0 1px 0 rgba(0, 0, 0, 0.25);
    --chip-shadow-hover: 0 2px 0 rgba(0, 0, 0, 0.28);
  }
}

/* =========================================
   BASE — Global Defaults, Viewport, A11y
   ========================================= */
@layer base {
  :root {
    color-scheme: light;
  }
  [data-theme="dark"] {
    color-scheme: dark;
  }

  html {
    height: 100%;
    background: var(--app-bg, var(--page-bg, var(--app-bg-fallback-light)));
  }

  body {
    margin: 0;
    background: inherit;
    min-height: 100svh;
  }

  @supports (height: 100dvh) {
    body {
      min-height: 100dvh;
    }
  }

  [data-theme="dark"] html {
    background: var(--app-bg, var(--page-bg, var(--app-bg-fallback-dark)));
  }

  [data-theme="dark"] body {
    background: inherit;
  }

  /* Universal interactive ergonomics (mobile) */
  :where(
    button,
    .btn,
    .btn-ghost,
    .btn-play-idea,
    .btn-icon,
    .mood-chip,
    .travel-chip,
    .compass-mode-chip,
    .tag-filter-chip,
    .bottom-nav-item
  ) {
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
  }

  /* Pressable: prevent selection where it feels wrong */
  :where(
    .btn,
    .btn-ghost,
    .btn-play-idea,
    .btn-icon,
    .mood-chip,
    .travel-chip,
    .compass-mode-chip,
    .tag-filter-chip,
    .btn-chip,
    .bottom-nav-item,
    .app-menu-item,
    .app-menu-lang-chip,
    .sidebar-section-close,
    .spot-details-route-link,
    .favorite-toggle,
    .popup-link
  ) {
    user-select: none;
    -webkit-user-select: none;
  }

  /* Focus: additive ring + existing elevation (no “shadow wipe”) */
  :where(
    button,
    .language-switcher,
    .btn-icon,
    .btn,
    .btn-ghost,
    .btn-play-idea,
    .mood-chip,
    .travel-chip,
    .compass-mode-chip,
    .tag-filter-chip,
    .bottom-nav-item,
    .input,
    select.input,
    textarea.input,
    .filter-group--checkbox input[type="checkbox"],
    .app-menu-item,
    .app-menu-lang-chip,
    .sidebar-section-close,
    .spot-details-route-link,
    .favorite-toggle,
    .popup-link
  ):focus-visible {
    outline: none;
    box-shadow:
      var(--focus-ring, var(--focus-ring-default)),
      var(--shadow, none);
  }

  /* Forced colors: ensure visible focus */
  @media (forced-colors: active) {
    :where(
      button,
      .btn,
      .btn-ghost,
      .btn-play-idea,
      .btn-icon,
      .bottom-nav-item,
      .input,
      select.input,
      textarea.input,
      .app-menu-item,
      .app-menu-lang-chip,
      .sidebar-section-close,
      .spot-details-route-link,
      .favorite-toggle,
      .popup-link
    ):focus-visible {
      outline: 2px solid Highlight;
      outline-offset: 2px;
      box-shadow: none !important;
    }
  }

  /* Prevent background scroll when modal/menu open */
  body[data-filter-modal-open="1"],
  body[data-menu-open="1"] {
    overflow: hidden;
    touch-action: none;
  }
}

/* =========================================
   COMPONENTS
   ========================================= */
@layer components {
  /* -----------------------------------------
     Form Controls – Select baseline
     ----------------------------------------- */
  select {
    background-color: var(--input-bg, rgba(255, 255, 255, 0.92));
    color: var(--text-color, #111827);
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    padding-right: 1.5rem;
    position: relative;
    z-index: 1;
  }

  /* -----------------------------------------
     Buttons
     ----------------------------------------- */
  :where(.btn, .btn-play-idea) {
    --shadow: var(--elevation-sm);

    position: relative;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.375rem;

    border-radius: var(--btn-radius);
    border: none;

    font-family: inherit;
    letter-spacing: 0.01em;

    /* Default CTA wiring (theme.css): solid background + readable text */
    background-color: var(--cta-bg, var(--accent-solid, var(--accent)));
    color: var(--cta-fg, var(--on-accent-solid, #ffffff));

    box-shadow: var(--shadow);
    cursor: pointer;
    text-decoration: none;

    transition:
      background-color var(--dur, var(--dur-fallback)) var(--ease-out, var(--ease-out-fallback)),
      box-shadow var(--dur, var(--dur-fallback)) var(--ease-out, var(--ease-out-fallback)),
      transform var(--dur-fast, var(--dur-fast-fallback)) var(--ease-out, var(--ease-out-fallback)),
      opacity var(--dur-fast, var(--dur-fast-fallback)) var(--ease-out, var(--ease-out-fallback));
  }

  .btn {
    min-height: var(--btn-height);
    padding: 0 1rem;
    font-size: 14px;
    font-weight: 650;
    line-height: 1.1;
  }

  .btn-small {
    min-height: 30px;
    padding: 0 0.85rem;
    font-size: 13px;
  }

  :where(.btn, .btn-play-idea):active {
    --shadow: var(--elevation-xs);
    transform: translateY(1px);
    opacity: 0.98;
  }

  [data-theme="dark"] :where(.btn, .btn-play-idea) {
    --shadow: var(--elevation-md);
  }

  /* Secondary buttons */
  .btn-secondary {
    --shadow: var(--elevation-xs);

    background-color: var(--neutral-0);
    color: var(--text-strong, #111827);
    border: var(--stroke-2);
    box-shadow: var(--shadow);
  }

  .btn-secondary:active {
    --shadow: var(--elevation-xs);
    background-color: var(--neutral-2);
  }

  [data-theme="dark"] .btn-secondary {
    --shadow: var(--elevation-sm);

    background: var(--neutral-0);
    color: var(--text-color, #e5e7eb);
    border: var(--stroke-2);
    box-shadow: var(--shadow);
  }

  /* Ghost buttons */
  .btn-ghost {
    --shadow: none;

    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.25rem;

    min-height: 32px;
    padding: 0 0.9rem;

    border-radius: var(--btn-radius);
    border: 1px solid transparent;

    background: transparent;
    color: var(--text-soft, #4b5563);

    font-size: 13px;
    font-weight: 650;

    box-shadow: var(--shadow);
    cursor: pointer;

    transition:
      background-color var(--dur-fast, var(--dur-fast-fallback)) var(--ease-out, var(--ease-out-fallback)),
      color var(--dur-fast, var(--dur-fast-fallback)) var(--ease-out, var(--ease-out-fallback)),
      border-color var(--dur-fast, var(--dur-fast-fallback)) var(--ease-out, var(--ease-out-fallback));
  }

  .btn-ghost:active {
    background-color: rgba(15, 23, 42, 0.07);
  }

  [data-theme="dark"] .btn-ghost {
    background: transparent;
    color: var(--text-color, #e5e7eb);
  }

  /* OPTIMIZED: ensure btn-small also compacts ghost buttons (Filter anzeigen / Nur Karte / Anzeigen) */
  .btn-ghost.btn-small {
    min-height: 28px;
    padding: 0 0.75rem;
    font-size: 12px;
  }

  /* Tilla / Compact primary button */
  .btn-play-idea {
    max-width: 100%;
    padding: 0.3rem 0.85rem;
    min-height: 34px;
    font-size: 13px;
    font-weight: 650;
    white-space: normal;
    gap: 6px;
    line-height: 1.15;

    /* REQUIRED: match Tilla shell color */
    background-color: var(--tilla-shell);
    color: var(--on-tilla-shell);
  }

  @media (max-width: 480px) {
    .btn-play-idea {
      font-size: 12px;
      padding-inline: 0.7rem;
    }
  }

  /* Disabled states */
  :where(.btn, .btn-play-idea, .btn-ghost, .btn-icon):disabled,
  :where(.btn, .btn-play-idea, .btn-ghost, .btn-icon)[aria-disabled="true"] {
    cursor: not-allowed;
    opacity: 0.55;
    transform: none !important;
    box-shadow: none !important;
    pointer-events: none;
  }

  /* -----------------------------------------
     HEADER
     ----------------------------------------- */
  .app-header {
    position: sticky;
    top: 0;
    z-index: 1200;

    padding: calc(env(safe-area-inset-top, 0px) + 10px) 14px 14px;

    background: linear-gradient(
      180deg,
      var(--header-bg-top),
      var(--header-bg-bottom)
    );
    color: var(--header-text-color);

    border-bottom-left-radius: 24px;
    border-bottom-right-radius: 24px;

    box-shadow: var(--header-shadow);
  }

  /* Light-mode header: warm muted */
  :where(html, body, :root)[data-theme="light"] .app-header {
    background: radial-gradient(
      circle at top left,
      var(--fsm-warm-0) 0,
      var(--fsm-warm-1) 52%,
      var(--fsm-warm-2) 100%
    );
    color: var(--text-strong, #111827);
    box-shadow: var(--elevation-md);

    --header-text-color: var(--text-strong, #111827);
    --header-tagline-bg: rgba(255, 255, 255, 0.56);
    --header-tagline-color: rgba(17, 24, 39, 0.92);
    --header-icon-bg: rgba(255, 255, 255, 0.72);
  }

  .app-header-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }

  .app-header-left,
  .app-header-right {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  /* Header icons */
  .btn-icon {
    --shadow: var(--elevation-sm);

    border: none;
    padding: 0;
    margin: 0;

    width: 40px;
    height: 40px;

    border-radius: var(--radius-pill, 999px);

    display: inline-flex;
    align-items: center;
    justify-content: center;

    background: var(--header-icon-bg);
    box-shadow: var(--shadow);

    font-size: 20px;
    cursor: pointer;

    transition:
      background-color var(--dur-fast, var(--dur-fast-fallback)) var(--ease-out, var(--ease-out-fallback)),
      box-shadow var(--dur-fast, var(--dur-fast-fallback)) var(--ease-out, var(--ease-out-fallback)),
      transform var(--dur-fast, var(--dur-fast-fallback)) var(--ease-out, var(--ease-out-fallback)),
      opacity var(--dur-fast, var(--dur-fast-fallback)) var(--ease-out, var(--ease-out-fallback));
  }

  .btn-icon:active {
    --shadow: var(--elevation-xs);
    transform: translateY(1px) scale(0.97);
    opacity: 0.92;
  }

  .btn-menu-icon {
    font-size: 20px;
  }

  /* legacy language-switcher is not used */
  .language-switcher {
    display: none;
  }

  .app-header-main {
    text-align: center;
  }

  .header-title {
    margin: 0;
    font-size: 24px;
    font-weight: 800;
    letter-spacing: 0.02em;

    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;

    text-shadow: none;
    color: var(--header-text-color);
  }

  :where(html, body, :root)[data-theme="light"] .header-title {
    color: var(--text-strong, #111827);
  }

  .header-title:focus-visible {
    outline: none;
    box-shadow: none;
  }

  .header-flag {
    font-size: 20px;
  }

  .header-title-spots {
    text-decoration: none;
  }

  /* REMOVE: frame around "Family Spots Map" */
  .header-title,
  .header-title-spots,
  .header-title-spots:link,
  .header-title-spots:visited {
    border: 0 !important;
    outline: none !important;
    box-shadow: none !important;
    background: transparent !important;
  }

  .header-title::before,
  .header-title::after,
  .header-title-spots::before,
  .header-title-spots::after {
    content: none !important;
  }

  .header-tagline {
    display: inline-block;
    margin: 8px auto 0;
    padding: 8px 20px;

    background: var(--header-tagline-bg);
    color: var(--header-tagline-color);

    border-radius: var(--radius-pill, 999px);
    font-size: 14px;
    font-weight: 650;

    box-shadow: var(--elevation-sm);
  }

  /* -----------------------------------------
     HEADER MENU (☰)
     ----------------------------------------- */
  .app-menu {
    position: fixed;
    inset: 0;
    z-index: 1800;
    display: none;
  }

  .app-menu[hidden] {
    display: none !important;
  }

  body:not([data-menu-open="1"]) .app-menu {
    display: none !important;
  }

  body[data-menu-open="1"] .app-menu {
    display: block;
  }

  .app-menu-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(15, 23, 42, 0.35);
  }

  .app-menu-panel {
    position: absolute;
    top: calc(env(safe-area-inset-top, 0px) + 52px);
    right: 14px;
    left: 14px;

    max-width: 420px;
    margin-left: auto;

    padding: 10px 10px 12px;
    border-radius: 24px;

    background: var(--card-bg, rgba(255, 255, 255, 0.98));
    border: 1px solid var(--card-border, rgba(148, 163, 184, 0.16));

    box-shadow: var(--elevation-lg);

    height: auto;
    max-height: min(
      70vh,
      calc(100vh - env(safe-area-inset-top, 0px) - 84px)
    );
    overflow: auto;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain;
  }

  [data-theme="dark"] .app-menu-panel {
    background: var(--card-bg, rgba(15, 23, 42, 0.99));
    border-color: var(--card-border, rgba(255, 255, 255, 0.08));
    box-shadow: var(--elevation-lg);
  }

  .app-menu-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-bottom: 8px;
  }

  .app-menu-item {
    --shadow: var(--elevation-sm);

    border: none;
    border-radius: 999px;
    padding: 7px 14px;

    display: inline-flex;
    align-items: center;
    justify-content: flex-start;
    gap: 10px;

    font-size: 14px;
    font-weight: 650;

    background: var(--neutral-0);
    color: var(--text-strong);

    border: var(--stroke-1);
    box-shadow: var(--shadow);

    cursor: pointer;

    transition:
      background-color var(--dur, var(--dur-fallback)) var(--ease-out, var(--ease-out-fallback)),
      box-shadow var(--dur, var(--dur-fallback)) var(--ease-out, var(--ease-out-fallback)),
      transform var(--dur-fast, var(--dur-fast-fallback)) var(--ease-out, var(--ease-out-fallback));
  }

  .app-menu-item:active {
    --shadow: var(--elevation-xs);
    transform: translateY(1px);
    background-color: var(--neutral-2);
  }

  [data-theme="dark"] .app-menu-item {
    --shadow: var(--elevation-md);

    background: var(--neutral-0);
    color: var(--text-color, #e5e7eb);
    border: var(--stroke-1);
    box-shadow: var(--shadow);
  }

  .app-menu-item-icon {
    width: 26px;
    height: 26px;

    border-radius: 999px;

    display: inline-flex;
    align-items: center;
    justify-content: center;

    background: var(--header-icon-bg);
    box-shadow: var(--elevation-xs);

    font-size: 18px;
  }

  .app-menu-item-label {
    flex: 1 1 auto;
    text-align: left;
  }

  /* Language chips */
  .app-menu-languages {
    margin-top: 4px;
    padding-top: 6px;
    border-top: var(--border-soft);
  }

  [data-theme="dark"] .app-menu-languages {
    border-top-color: rgba(148, 163, 184, 0.25);
  }

  .app-menu-languages-label {
    margin: 0 0 4px;
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--text-soft);
  }

  .app-menu-languages-row {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .app-menu-lang-chip {
    --shadow: var(--elevation-xs);

    border: none;
    border-radius: 999px;
    padding: 5px 10px;

    display: inline-flex;
    align-items: center;
    gap: 6px;

    background: var(--neutral-1);
    color: var(--text-strong);

    font-size: 13px;
    font-weight: 650;

    box-shadow: var(--shadow);
    cursor: pointer;

    transition:
      background-color var(--dur, var(--dur-fallback)) var(--ease-out, var(--ease-out-fallback)),
      box-shadow var(--dur, var(--dur-fallback)) var(--ease-out, var(--ease-out-fallback));
  }

  [data-theme="dark"] .app-menu-lang-chip {
    --shadow: var(--elevation-sm);

    background: var(--neutral-1);
    color: var(--text-color, #e5e7eb);
    box-shadow: var(--shadow);
  }

  .app-menu-lang-chip--active {
    --shadow: var(--elevation-md);

    background: var(--accent-soft);
    color: var(--on-accent, #111827);
    box-shadow: var(--shadow);
  }

  [data-theme="dark"] .app-menu-lang-chip--active {
    background: var(--accent);
    color: var(--on-accent, #111827);
  }

  .app-menu-lang-flag {
    font-size: 16px;
  }

  .app-menu-lang-code {
    font-size: 12px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }

  /* -----------------------------------------
     MAIN LAYOUT
     ----------------------------------------- */
  .app-main {
    flex: 1;
    width: 100%;
    max-width: 1120px;
    margin: 0 auto;
    padding: 16px 12px calc(96px + env(safe-area-inset-bottom, 0px));
  }

  .view {
    display: none;
  }

  .view--active {
    display: block;
  }

  /* -----------------------------------------
     MAP VIEW & SIDEBAR
     ----------------------------------------- */
  #view-map {
    display: flex;
    flex-direction: column;
    gap: 14px;
  }

  .sidebar {
    display: flex;
    flex-direction: column;
    gap: 12px;
    background: transparent;
  }

  [data-theme="dark"] #view-map {
    background: linear-gradient(
      to bottom,
      rgba(2, 6, 23, 0.88) 0,
      rgba(2, 6, 23, 0.88) 100%
    );
    border-radius: 0 0 28px 28px;
  }

  /* Sections / Cards */
  .sidebar-section {
    background: var(--sidebar-section-bg);
    border-radius: 20px;
    padding: 12px 14px 14px;
    box-shadow: var(--sidebar-section-shadow);
    border: 1px solid var(--sidebar-section-border);
  }

  /* OPTIMIZED: Compact the three marked header cards (Filter / Plus / Mein Tag) and Spots */
  #filter-section.sidebar-section,
  .sidebar-section.sidebar-section--grow,
  #plus-section.sidebar-section,
  #daylog-section.sidebar-section {
    padding: 8px 14px 10px;
  }

  #plus-section.sidebar-section[open],
  #daylog-section.sidebar-section[open] {
    padding-bottom: 10px;
  }

  /* global stack spacing */
  .sidebar-section + .sidebar-section {
    margin-top: 10px;
  }
  .sidebar > .sidebar-section + .sidebar-section {
    margin-top: 0;
  }

  /* Map card */
  .map-section {
    border-radius: 22px;
    overflow: hidden;
    box-shadow: var(--map-card-shadow);
    background: var(--map-card-bg);
    border: 1px solid var(--map-card-border);
    min-height: 320px;
    position: relative;
    margin-top: 14px;
    margin-bottom: 14px;
  }

  /* plus-section ↔ daylog-section spacing */
  #plus-section + #daylog-section {
    margin-top: 14px;
  }

  .sidebar-section[open] {
    padding-bottom: 14px;
  }

  /* ================================
     FIX: Header row (Filter / Spots)
     - wieder kompakt (oben/unten)
     - Action rechts bleibt „textig“
     ================================ */
  .sidebar-section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;

    width: 100%;
    min-width: 0;
    flex-wrap: nowrap;

    /* NEW: verhindert „hohe“ Header-Zeilen */
    min-height: 40px;
  }

  /* NEW: rechter Bereich darf nicht wachsen / umbrechen */
  .sidebar-section-header > :last-child {
    margin-left: auto;
    flex: 0 0 auto;
    width: auto;
    max-width: 100%;
    white-space: nowrap;
  }

  /* FIX: allow title to shrink/truncate instead of pushing action / increasing height */
  .sidebar-section-title {
    margin: 0;
    font-size: 18px;
    font-weight: 700;
    color: var(--text-strong);

    flex: 1 1 auto;
    min-width: 0;

    /* NEW: kompakter wie im alten Screenshot */
    line-height: 1.15;
  }

  /* FIX (robust): Action im Header generell kompakt halten (egal ob Button/Link/Span) */
  :where(#filter-section, .sidebar-section--grow) .sidebar-section-header > :last-child,
  :where(#filter-section, .sidebar-section--grow) .sidebar-section-header > :last-child :where(button, a) {
    display: inline-flex;
    align-items: center;
    justify-content: center;

    min-height: 28px;
    padding: 0 0.75rem;

    font-size: 12px;
    font-weight: 650;
    line-height: 1;

    background: transparent;
    border: 1px solid transparent;
    box-shadow: none;

    border-radius: var(--btn-radius);
    white-space: nowrap;
  }

  :where(#filter-section, .sidebar-section--grow) .sidebar-section-header > :last-child:active,
  :where(#filter-section, .sidebar-section--grow) .sidebar-section-header > :last-child :where(button, a):active {
    background-color: rgba(15, 23, 42, 0.07);
  }

  [data-theme="dark"] :where(#filter-section, .sidebar-section--grow) .sidebar-section-header > :last-child,
  [data-theme="dark"] :where(#filter-section, .sidebar-section--grow) .sidebar-section-header > :last-child :where(button, a) {
    color: var(--text-color, #e5e7eb);
  }

  [data-theme="dark"] :where(#filter-section, .sidebar-section--grow) .sidebar-section-header > :last-child:active,
  [data-theme="dark"] :where(#filter-section, .sidebar-section--grow) .sidebar-section-header > :last-child :where(button, a):active {
    background-color: rgba(148, 163, 184, 0.14);
  }

  /* (falls IDs existieren) zusätzliche Absicherung */
  #btn-toggle-filters,
  #btn-toggle-spots {
    flex: 0 0 auto !important;
    width: auto !important;
    max-width: 100%;

    min-height: 28px;
    padding: 0 0.75rem;

    background: transparent;
    border: 1px solid transparent;
    box-shadow: none;

    border-radius: var(--btn-radius);
    font-size: 12px;
    font-weight: 650;
    line-height: 1;
    white-space: nowrap;
  }

  #btn-toggle-filters:active,
  #btn-toggle-spots:active {
    background-color: rgba(15, 23, 42, 0.07);
  }

  [data-theme="dark"] #btn-toggle-filters,
  [data-theme="dark"] #btn-toggle-spots {
    color: var(--text-color, #e5e7eb);
  }

  [data-theme="dark"] #btn-toggle-filters:active,
  [data-theme="dark"] #btn-toggle-spots:active {
    background-color: rgba(148, 163, 184, 0.14);
  }

  /* OPTIMIZED: Details/Summary headers should not show markers (Plus / Mein Tag) */
  summary.sidebar-section-header {
    list-style: none;
    cursor: pointer;
  }
  summary.sidebar-section-header::-webkit-details-marker {
    display: none;
  }
  summary.sidebar-section-header::marker {
    content: "";
  }

  .sidebar-section-close {
    --shadow: var(--elevation-xs);

    border: none;
    padding: 6px 14px;
    border-radius: var(--radius-pill, 999px);

    background: var(--neutral-0);
    border: var(--stroke-2);
    box-shadow: var(--shadow);

    font-size: 14px;
    font-weight: 650;
    cursor: pointer;

    transition:
      background-color var(--dur, var(--dur-fallback)) var(--ease-out, var(--ease-out-fallback)),
      box-shadow var(--dur, var(--dur-fallback)) var(--ease-out, var(--ease-out-fallback)),
      transform var(--dur-fast, var(--dur-fast-fallback)) var(--ease-out, var(--ease-out-fallback));
  }

  .sidebar-section-close:active {
    --shadow: var(--elevation-xs);
    background: var(--neutral-2);
    transform: translateY(1px);
  }

  [data-theme="dark"] .sidebar-section-close {
    --shadow: var(--elevation-sm);

    background: var(--neutral-0);
    color: var(--text-color, #e5e7eb);
    border: var(--stroke-2);
    box-shadow: var(--shadow);
  }

  .sidebar-section--collapsed {
    padding-bottom: 10px;
  }

  .sidebar-section--collapsed > .filter-group {
    display: none;
  }

  /* Compass card */
  .compass-card {
    margin-top: 4px;
    padding: 10px 10px 12px;
    border-radius: 16px;
    background: var(--card-bg, var(--fsm-surface-warm, #f5e3d4));
    box-shadow: var(--elevation-sm);
    border: var(--border-soft);
  }

  [data-theme="dark"] .compass-card {
    background: var(--card-bg);
    box-shadow: var(--elevation-md);
    border: var(--border-soft);
  }

  /* -----------------------------------------
     Form Controls in Sidebar
     ----------------------------------------- */
  .filter-group {
    margin-top: 8px;
  }

  .filter-group-label {
    display: block;
    font-size: 13px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-strong);
    margin-bottom: 4px;
  }

  .filter-group-helper {
    margin: 0 0 6px;
    font-size: 13px;
    color: var(--text-soft);
  }

  .filter-group-helper--compact {
    margin-top: 4px;
    margin-bottom: 6px;
    font-size: 13px;
    color: var(--text-soft);
  }

  #btn-toggle-filters {
    margin-bottom: 0;
  }

  /* OPTIMIZED: reduce the extra vertical space under "Filter" header */
  .sidebar-section-header + .filter-group-helper {
    margin-top: 0.45rem;
  }

  /* Footer under base filters */
  .filter-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    margin-top: 10px;
  }

  .filter-summary {
    margin: 0;
    font-size: 12px;
    color: var(--text-soft);
  }

  .input,
  textarea.input,
  select.input {
    width: 100%;
    border-radius: var(--radius-pill, 999px);
    border: 1px solid rgba(209, 213, 219, 0.9);

    padding: 9px 13px;
    font-size: 14px;
    font-family: inherit;

    background: var(--input-bg, rgba(255, 255, 255, 0.92));
    background-clip: padding-box;

    box-shadow: none;
    color: var(--text-color, #111827);

    transition:
      border-color var(--dur, var(--dur-fallback)) var(--ease-out, var(--ease-out-fallback)),
      box-shadow var(--dur, var(--dur-fallback)) var(--ease-out, var(--ease-out-fallback)),
      background-color var(--dur, var(--dur-fallback)) var(--ease-out, var(--ease-out-fallback));
  }

  textarea.input {
    border-radius: 16px;
    resize: vertical;
  }

  :where(.input, textarea.input, select.input):hover {
    border-color: rgba(148, 163, 184, 0.55);
  }

  .input:focus,
  textarea.input:focus,
  select.input:focus {
    outline: none;
    border-color: hsla(var(--accent-h, 28), 72%, 52%, 0.65);
    box-shadow: 0 0 0 1px hsla(var(--accent-h, 28), 72%, 52%, 0.45);
  }

  /* Select chevron */
  select.input {
    padding-right: 2.35rem;
    background-image:
      linear-gradient(45deg, transparent 50%, rgba(15, 23, 42, 0.55) 50%),
      linear-gradient(135deg, rgba(15, 23, 42, 0.55) 50%, transparent 50%);
    background-position:
      calc(100% - 18px) 50%,
      calc(100% - 12px) 50%;
    background-size: 6px 6px;
    background-repeat: no-repeat;
  }

  [data-theme="dark"] select.input {
    background-image:
      linear-gradient(45deg, transparent 50%, rgba(229, 231, 235, 0.7) 50%),
      linear-gradient(135deg, rgba(229, 231, 235, 0.7) 50%, transparent 50%);
  }

  /* -----------------------------------------
     Mood / Travel / Tag chips (Bild 3 Look)
     - aktiv über aria-pressed="true" (A11y)
     ----------------------------------------- */
  .mood-row {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .tag-filter-row {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  :where(.mood-chip, .travel-chip, .compass-mode-chip, .tag-filter-chip, .btn-chip) {
    --shadow: var(--chip-shadow);

    border-radius: var(--radius-pill, 999px);
    padding: 6px 12px 7px;

    display: inline-flex;
    align-items: center;
    gap: 6px;

    font-size: 13px;
    font-weight: 650;
    line-height: 1.1;

    background: var(--chip-bg, var(--chip-surface));
    color: var(--text-color, #374151);

    border: 1px solid var(--chip-border);
    box-shadow: var(--shadow);

    cursor: pointer;

    transition:
      background-color var(--dur-fast, var(--dur-fast-fallback)) var(--ease-out, var(--ease-out-fallback)),
      border-color var(--dur-fast, var(--dur-fast-fallback)) var(--ease-out, var(--ease-out-fallback)),
      color var(--dur-fast, var(--dur-fast-fallback)) var(--ease-out, var(--ease-out-fallback)),
      box-shadow var(--dur-fast, var(--dur-fast-fallback)) var(--ease-out, var(--ease-out-fallback)),
      transform var(--dur-fast, var(--dur-fast-fallback)) var(--ease-out, var(--ease-out-fallback));
  }

  :where(.mood-chip, .travel-chip, .compass-mode-chip, .tag-filter-chip, .btn-chip):active {
    --shadow: var(--chip-shadow);
    transform: translateY(1px);
  }

  .mood-chip-emoji {
    font-size: 15px;
  }

  :where(.mood-chip, .travel-chip, .compass-mode-chip, .tag-filter-chip, .btn-chip)[aria-pressed="true"] {
    border-color: var(--chip-active-border);
    box-shadow: none;
    transform: none;
  }

  :where(.mood-chip--active, .travel-chip--active, .compass-mode-chip--active, .tag-filter-chip--active) {
    border-color: var(--chip-active-border);
    box-shadow: none;
    transform: none;
  }

  [data-theme="dark"] :where(.mood-chip, .travel-chip, .compass-mode-chip, .tag-filter-chip, .btn-chip) {
    --shadow: var(--chip-shadow);

    background: var(--surface-3, rgba(15, 23, 42, 0.98));
    color: var(--text-color, #e5e7eb);
    border-color: var(--chip-border);
    box-shadow: var(--shadow);
  }

  [data-theme="dark"]
    :where(.mood-chip, .travel-chip, .compass-mode-chip, .tag-filter-chip, .btn-chip)[aria-pressed="true"] {
    border-color: var(--chip-active-border);
    box-shadow: none;
  }

  .btn-chip {
    font-weight: 650;
    padding: 5px 10px;
  }

  /* Radius */
  .radius-row {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  #filter-radius {
    flex: 1;
  }

  .radius-max-label {
    font-size: 13px;
    font-weight: 650;
    color: var(--text-strong);
  }

  .radius-description {
    margin: 4px 0 2px;
    font-size: 13px;
    color: var(--text-soft);
  }

  /* Advanced filters */
  .filter-advanced {
    margin-top: 4px;
    padding-top: 4px;
    border-top: var(--border-soft);
  }

  [data-theme="dark"] .filter-advanced {
    border-top-color: rgba(148, 163, 184, 0.22);
  }

  .filter-advanced-summary {
    display: none;
  }

  .filter-advanced-summary .filter-group-label {
    margin: 0;
  }

  /* Checkbox */
  .filter-group--checkbox {
    margin-top: 4px;
  }

  .checkbox-label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
  }

  .filter-group--checkbox input[type="checkbox"] {
    -webkit-appearance: none;
    appearance: none;
    width: 18px;
    height: 18px;
    border-radius: 6px;
    border: 1px solid rgba(209, 213, 219, 1);
    background: var(--neutral-0);
    box-shadow: none;
    cursor: pointer;
    position: relative;
    flex-shrink: 0;
  }

  [data-theme="dark"] .filter-group--checkbox input[type="checkbox"] {
    background: var(--neutral-0);
    border-color: rgba(148, 163, 184, 0.45);
  }

  .filter-group--checkbox input[type="checkbox"]:checked {
    background: var(--accent);
    border-color: var(--accent);
  }

  .filter-group--checkbox input[type="checkbox"]:checked::after {
    content: "";
    position: absolute;
    inset: 4px;
    border-radius: 3px;
    background: #ffffff;
  }

  .filter-group--checkbox input[type="checkbox"]:active {
    filter: brightness(0.96);
  }

  /* Plus-code form */
  .plus-code-form {
    margin-top: 6px;
    font-size: 14px;
  }

  .plus-code-row {
    display: flex;
    gap: 8px;
    margin: 6px 0;
  }

  .plus-note {
    margin: 0;
    font-size: 13px;
    color: var(--text-soft);
  }

  /* Daylog spacing */
  #daylog-section .filter-group label {
    display: block;
    margin-bottom: 6px;
  }

  #daylog-text {
    min-height: 70px;
  }

  #daylog-save {
    margin-top: 14px;
  }

  /* -----------------------------------------
     Daylog list & entries
     ----------------------------------------- */
  .daylog-list,
  #daylog-list {
    margin-top: 0.75rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    max-height: clamp(180px, 26vh, 260px);
    overflow-y: auto;
    padding-right: 4px;
    padding-top: 0.2rem;
    scrollbar-width: thin;
    scrollbar-color: rgba(148, 163, 184, 0.6) transparent;
  }

  .daylog-list::-webkit-scrollbar,
  #daylog-list::-webkit-scrollbar {
    width: 6px;
  }

  .daylog-list::-webkit-scrollbar-track,
  #daylog-list::-webkit-scrollbar-track {
    background: transparent;
  }

  .daylog-list::-webkit-scrollbar-thumb,
  #daylog-list::-webkit-scrollbar-thumb {
    border-radius: 999px;
    background: rgba(148, 163, 184, 0.55);
  }

  [data-theme="dark"] .daylog-list::-webkit-scrollbar-thumb,
  [data-theme="dark"] #daylog-list::-webkit-scrollbar-thumb {
    background: rgba(148, 163, 184, 0.55);
  }

  .daylog-entry {
    position: relative;
    padding: 0.8rem 0.9rem 0.85rem 1.25rem;
    border-radius: 0.9rem;
    font-size: 0.9rem;
    line-height: 1.6;
    transition:
      transform var(--dur, var(--dur-fallback)) var(--ease-out, var(--ease-out-fallback)),
      box-shadow var(--dur, var(--dur-fallback)) var(--ease-out, var(--ease-out-fallback)),
      background-color var(--dur, var(--dur-fallback)) var(--ease-out, var(--ease-out-fallback)),
      border-color var(--dur, var(--dur-fallback)) var(--ease-out, var(--ease-out-fallback));
  }

  [data-theme="light"] .daylog-entry {
    background-color: var(--card-bg, #ffffff);
    border: 1px solid rgba(148, 163, 184, 0.24);
    box-shadow: var(--elevation-xs);
  }

  [data-theme="dark"] .daylog-entry {
    background-color: var(--surface-2, rgba(2, 6, 23, 0.92));
    border: 1px solid rgba(255, 255, 255, 0.08);
    box-shadow: var(--elevation-md);
  }

  .daylog-entry:focus-within {
    transform: translateY(-1px);
    box-shadow: var(--elevation-md);
  }

  .daylog-entry::before {
    content: "";
    position: absolute;
    left: 0.5rem;
    top: 0.75rem;
    bottom: 0.75rem;
    width: 2px;
    border-radius: 999px;
    background: linear-gradient(to bottom, var(--accent-light), var(--accent-dark));
  }

  .daylog-entry::after {
    content: "";
    position: absolute;
    left: 0.31rem;
    top: 0.7rem;
    width: 9px;
    height: 9px;
    border-radius: 999px;
    background: var(--accent-light);
    box-shadow: 0 0 0 3px hsla(var(--accent-h, 28), 72%, 58%, 0.22);
  }

  .daylog-entry-header {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    gap: 0.5rem;
    margin-bottom: 0.25rem;
  }

  .daylog-entry-date {
    margin: 0;
    font-size: 0.78rem;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    opacity: 0.85;
  }

  [data-theme="light"] .daylog-entry-date {
    color: rgba(15, 23, 42, 0.6);
  }

  [data-theme="dark"] .daylog-entry-date {
    color: rgba(203, 213, 225, 0.78);
  }

  .daylog-entry-text {
    margin: 0.15rem 0 0;
    white-space: pre-wrap;
  }

  .daylog-entry:last-child {
    margin-bottom: 0.1rem;
  }

  /* -----------------------------------------
     Spot list
     ----------------------------------------- */
  .sidebar-section--grow {
    flex: 1 1 auto;
    display: flex;
    flex-direction: column;
  }

  .sidebar-section--grow.spot-list-collapsed {
    padding-bottom: 10px;
  }

  .sidebar-section--grow.spot-list-collapsed #spot-list {
    display: none;
  }

  #spot-list {
    margin-top: 6px; /* OPTIMIZED: was 8px */
    max-height: 320px;
    overflow-y: auto;
    padding-right: 4px;
    scrollbar-width: thin;
    scrollbar-color: rgba(148, 163, 184, 0.6) transparent;
  }

  #spot-list::-webkit-scrollbar {
    width: 6px;
  }
  #spot-list::-webkit-scrollbar-track {
    background: transparent;
  }
  #spot-list::-webkit-scrollbar-thumb {
    border-radius: 999px;
    background: rgba(148, 163, 184, 0.55);
  }
  [data-theme="dark"] #spot-list::-webkit-scrollbar-thumb {
    background: rgba(148, 163, 184, 0.55);
  }

  .empty-state {
    padding: 12px 12px 14px;
    border-radius: 16px;
    background: var(--card-bg, #ffffff);
    box-shadow: var(--elevation-xs);
    border: var(--border-soft);
    font-size: 14px;
  }

  .empty-state-title {
    margin: 0 0 4px;
    font-size: 15px;
    font-weight: 700;
    color: var(--text-strong);
  }

  .empty-state-text {
    margin: 0 0 8px;
    font-size: 13px;
    color: var(--text-soft);
  }

  .empty-state-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  [data-theme="dark"] .empty-state {
    background: var(--card-bg);
    color: var(--text-color, #e5e7eb);
    border: var(--border-soft);
  }

  .spot-card {
    position: relative;
    background: var(--card-bg);
    border-radius: 16px;
    padding: 10px 11px 11px;
    margin-bottom: 8px;
    box-shadow: var(--elevation-xs);
    border: var(--border-soft);
    cursor: pointer;
    transition:
      transform var(--dur-fast, var(--dur-fast-fallback)) var(--ease-out, var(--ease-out-fallback)),
      box-shadow var(--dur, var(--dur-fallback)) var(--ease-out, var(--ease-out-fallback)),
      border-color var(--dur, var(--dur-fallback)) var(--ease-out, var(--ease-out-fallback)),
      background-color var(--dur, var(--dur-fallback)) var(--ease-out, var(--ease-out-fallback));
  }

  .spot-card:focus-within {
    transform: translateY(-1px);
    box-shadow: var(--elevation-md);
    border-color: rgba(148, 163, 184, 0.4);
  }

  .spot-card-title {
    font-size: 15px;
    font-weight: 700;
    margin: 0 0 3px;
    letter-spacing: 0.01em;
  }

  .spot-card-subtitle {
    font-size: 13px;
    margin: 0 0 4px;
    color: var(--text-soft);
  }

  .spot-card-meta {
    font-size: 12px;
    color: var(--text-soft);
  }

  .spot-list-empty {
    padding: 10px 12px;
    border-radius: 16px;
    background: var(--card-bg, #ffffff);
    font-size: 14px;
    line-height: 1.5;
    color: var(--text-soft);
    box-shadow: var(--elevation-xs);
    border: var(--border-soft);
  }

  [data-theme="dark"] .spot-list-empty {
    background: var(--card-bg);
    color: var(--text-color, #e5e7eb);
  }

  .spot-card-description {
    margin: 4px 0 6px;
    font-size: 13px;
    line-height: 1.4;
    color: var(--text-soft);
  }

  .spot-card-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin-top: 4px;
  }

  .spot-card-actions {
    margin-top: 4px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
    color: var(--text-soft);
  }

  .spot-card-fav-icon {
    font-size: 16px;
  }

  .spot-card-detail-label {
    font-weight: 650;
  }

  .spot-details--hidden {
    display: none;
  }

  .spot-details {
    position: static;
    margin: 8px 10px 10px;
    max-height: none;
    overflow-y: visible;
    background: var(--card-bg);
    border-radius: 18px;
    box-shadow: var(--elevation-lg);
    padding: 10px 12px 11px;
    border: var(--border-soft);
  }

  [data-theme="dark"] .spot-details {
    background: var(--surface-2, rgba(15, 23, 42, 0.98));
    color: var(--text-color, #fef3e7);
    box-shadow: var(--elevation-lg);
    border: 1px solid rgba(255, 255, 255, 0.08);
  }

  .spot-details-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 8px;
    margin-bottom: 6px;
  }

  .spot-details-title {
    margin: 0 0 2px;
    font-size: 16px;
    font-weight: 700;
  }

  .spot-details-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    font-size: 12px;
    color: var(--text-soft);
  }

  .spot-details-meta span {
    padding: 2px 7px;
    border-radius: var(--radius-pill, 999px);
    background: var(--neutral-1);
    border: var(--stroke-1);
  }

  [data-theme="dark"] .spot-details-meta span {
    background: var(--neutral-1);
    border: var(--stroke-1);
  }

  .spot-details-actions {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .spot-details-tags {
    margin: 4px 0 6px;
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
  }

  .spot-details-description {
    margin: 4px 0 6px;
    font-size: 14px;
    line-height: 1.5;
  }

  .spot-details-poetry {
    margin: 0 0 6px;
    font-size: 14px;
    font-style: italic;
    color: var(--text-soft);
  }

  .spot-details-address {
    margin: 0 0 6px;
    font-size: 13px;
    color: var(--text-soft);
  }

  .spot-details-routes {
    margin-top: 6px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .spot-details-route-link {
    --shadow: var(--elevation-xs);

    font-size: 13px;
    font-weight: 650;
    padding: 6px 10px;
    border-radius: var(--radius-pill, 999px);

    background: var(--neutral-0);
    color: var(--text-strong, #1f2933);

    border: var(--stroke-2);
    box-shadow: var(--shadow);

    transition:
      background-color var(--dur, var(--dur-fallback)) var(--ease-out, var(--ease-out-fallback)),
      box-shadow var(--dur, var(--dur-fallback)) var(--ease-out, var(--ease-out-fallback)),
      transform var(--dur-fast, var(--dur-fast-fallback)) var(--ease-out, var(--ease-out-fallback));
  }

  .spot-details-route-link:active {
    --shadow: var(--elevation-xs);
    background: var(--neutral-2);
    transform: translateY(1px);
  }

  [data-theme="dark"] .spot-details-route-link {
    background: var(--neutral-0);
    color: var(--text-color, #e5e7eb);
    border: var(--stroke-2);
  }

  .favorite-toggle {
    --shadow: var(--elevation-xs);

    margin-top: 12px;
    border-radius: var(--radius-pill, 999px);
    padding: 6px 12px;

    background: var(--neutral-0);
    color: var(--text-strong, #374151);

    cursor: pointer;
    font-size: 14px;
    font-weight: 650;

    border: var(--stroke-2);
    box-shadow: var(--shadow);

    transition:
      background-color var(--dur, var(--dur-fallback)) var(--ease-out, var(--ease-out-fallback)),
      box-shadow var(--dur, var(--dur-fallback)) var(--ease-out, var(--ease-out-fallback)),
      transform var(--dur-fast, var(--dur-fast-fallback)) var(--ease-out, var(--ease-out-fallback));
  }

  .favorite-toggle:active {
    --shadow: var(--elevation-xs);
    background-color: var(--neutral-2);
    transform: translateY(1px);
  }

  [data-theme="dark"] .favorite-toggle {
    --shadow: var(--elevation-sm);

    background: var(--neutral-0);
    color: var(--text-color, #e5e7eb);
    border: var(--stroke-2);
    box-shadow: var(--shadow);
  }

  .map-container {
    width: 100%;
    height: 100%;
    min-height: 320px;
  }

  .leaflet-container .leaflet-tile {
    filter: var(--map-filter);
    transition: filter var(--dur-slow, var(--dur-slow-fallback)) var(--ease-out, var(--ease-out-fallback));
  }

  @media (max-width: 899px) {
    .map-section {
      min-height: 60vh;
    }

    .map-container {
      min-height: 60vh;
    }
  }

  @media (min-width: 900px) {
    #view-map {
      flex-direction: row;
      align-items: flex-start;
    }

    .sidebar {
      flex: 0 0 320px;
    }

    .map-section {
      flex: 1 1 auto;
      min-height: 560px;
      margin-top: 0;
      margin-bottom: 0;
      margin-left: 14px;
    }

    #spot-list {
      max-height: 380px;
    }

    .spot-details {
      position: absolute;
      margin: 0;
      right: 16px;
      bottom: 16px;
      left: auto;
      width: 320px;
      max-height: 75%;
      overflow-y: auto;
    }
  }

  /* -----------------------------------------
     FILTER MODAL (BOTTOM SHEET)
     ----------------------------------------- */
  .filter-modal {
    position: fixed;
    inset: 0;
    display: flex;
    justify-content: center;
    align-items: flex-end;
    padding: 0 16px 16px;
    background: rgba(0, 0, 0, 0.35);
    z-index: 2000;
  }

  .filter-modal[hidden] {
    display: none;
  }

  .filter-modal-inner {
    width: 100%;
    max-width: 720px;
    max-height: calc(100vh - 32px);
    background: var(--card-bg);
    border-radius: 20px 20px 0 0;
    box-shadow: 0 -8px 24px rgba(15, 23, 42, 0.22);
    border: var(--border-soft);
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain;
    padding: 16px 20px 20px;
  }

  .filter-modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    margin-bottom: 10px;
  }

  #filter-modal-title {
    margin: 0;
    font-size: 20px;
  }

  #filter-modal-close {
    --shadow: var(--elevation-xs);

    border-radius: var(--radius-pill, 999px);
    padding: 6px 16px;

    background: var(--neutral-0);
    color: var(--text-strong, #374151);

    font-size: 13px;
    font-weight: 650;

    border: var(--stroke-2);
    box-shadow: var(--shadow);

    cursor: pointer;

    transition:
      background-color var(--dur, var(--dur-fallback)) var(--ease-out, var(--ease-out-fallback)),
      box-shadow var(--dur, var(--dur-fallback)) var(--ease-out, var(--ease-out-fallback)),
      transform var(--dur-fast, var(--dur-fast-fallback)) var(--ease-out, var(--ease-out-fallback));
  }

  #filter-modal-close:active {
    --shadow: var(--elevation-xs);
    background: var(--neutral-2);
    transform: translateY(1px);
  }

  [data-theme="dark"] #filter-modal-close {
    --shadow: var(--elevation-sm);

    background: var(--neutral-0);
    color: var(--text-color, #e5e7eb);
    border: var(--stroke-2);
    box-shadow: var(--shadow);
  }

  .filter-modal-footer {
    margin-top: 14px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
  }

  /* -----------------------------------------
     TILLA SIDEBAR
     ----------------------------------------- */
  @keyframes tilla-bob {
    0% { transform: translateY(0) rotate(0deg); }
    25% { transform: translateY(-2px) rotate(-2deg); }
    50% { transform: translateY(-3px) rotate(2.5deg); }
    75% { transform: translateY(-2px) rotate(-1.5deg); }
    100% { transform: translateY(0) rotate(0); }
  }

  @keyframes tilla-card-in {
    0% { opacity: 0; transform: translateY(6px); }
    100% { opacity: 1; transform: translateY(0); }
  }

  .tilla-sidebar-section {
    padding-top: 10px;
    padding-bottom: 10px;
  }

  .tilla-sidebar-card {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 10px 12px;
    border-radius: 18px;
    background: var(--card-bg);
    box-shadow: var(--elevation-sm);
    border: var(--border-soft);
    animation: tilla-card-in 0.45s ease-out 0.1s both;
  }

  [data-theme="dark"] .tilla-sidebar-card {
    background: var(--surface-2, rgba(15, 23, 42, 0.97));
    box-shadow: var(--elevation-md);
    border: 1px solid rgba(255, 255, 255, 0.08);
  }

  .tilla-sidebar-avatar {
    flex: 0 0 auto;
  }

  .tilla-sidebar-avatar img {
    display: block;
    width: 110px;
    height: auto;
    transform-origin: center bottom;
    animation: tilla-bob 3.5s ease-in-out infinite;
  }

  .tilla-sidebar-text {
    flex: 1 1 auto;
  }

  #tilla-sidebar-text {
    margin: 0;
    font-size: 14px;
    line-height: 1.5;
  }

  /* -----------------------------------------
     ABOUT VIEW
     ----------------------------------------- */
  .page-about {
    background: var(--card-bg);
    border-radius: 22px;
    padding: 18px 16px 22px;
    box-shadow: var(--elevation-sm);
    border: var(--border-soft);
  }

  .page-about h2 {
    margin-top: 0;
    margin-bottom: 16px;
    font-size: 22px;
  }

  .page-about h3 {
    margin-top: 18px;
    margin-bottom: 6px;
    font-size: 18px;
  }

  .page-about p {
    margin-top: 4px;
    margin-bottom: 8px;
    line-height: 1.5;
    font-size: 15px;
  }

  /* -----------------------------------------
     BOTTOM NAV
     ----------------------------------------- */
  .bottom-nav {
    position: fixed;
    left: 0;
    right: 0;
    bottom: env(safe-area-inset-bottom, 0px);
    z-index: 30;
    height: 64px;
    pointer-events: none;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .bottom-nav-background {
    position: absolute;
    left: 10px;
    right: 10px;
    top: 8px;
    bottom: 8px;
    border-radius: 999px;
    background: var(--bottom-nav-backdrop);
    opacity: 0.96;
    backdrop-filter: blur(14px);
  }

  .bottom-nav-indicator {
    display: none;
  }

  .bottom-nav-item {
    pointer-events: auto;
    border: none;
    background: transparent;
    border-radius: var(--radius-pill, 999px);
    padding: 6px 14px;
    margin: 0 4px;
    min-width: 84px;

    display: inline-flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 2px;

    font-size: 0.7rem;
    font-weight: 650;
    color: var(--bottom-nav-item-color);
    cursor: pointer;

    transition:
      background-color var(--dur-fast, var(--dur-fast-fallback)) var(--ease-out, var(--ease-out-fallback)),
      color var(--dur-fast, var(--dur-fast-fallback)) var(--ease-out, var(--ease-out-fallback)),
      transform var(--dur-fast, var(--dur-fast-fallback)) var(--ease-out, var(--ease-out-fallback));
  }

  .bottom-nav-item--active {
    background: var(--bottom-nav-item-active-bg);
    color: var(--bottom-nav-item-active-color);
  }

  .bottom-nav-item:active {
    transform: translateY(1px);
  }

  .bottom-nav-icon {
    font-size: 1.1rem;
  }

  /* -----------------------------------------
     TOAST
     ----------------------------------------- */
  .toast {
    position: fixed;
    left: 50%;
    bottom: calc(90px + env(safe-area-inset-bottom, 0px));
    transform: translateX(-50%);
    max-width: 90%;
    background: var(--toast-bg);
    color: #fff7ec;
    border-radius: var(--radius-pill, 999px);
    padding: 8px 16px;
    font-size: 14px;
    box-shadow: var(--elevation-lg);
    opacity: 0;
    pointer-events: none;
    transition:
      opacity var(--dur, var(--dur-fallback)) var(--ease-out, var(--ease-out-fallback)),
      transform var(--dur, var(--dur-fallback)) var(--ease-out, var(--ease-out-fallback));
    z-index: 1100;
    will-change: transform, opacity;
  }

  .toast--visible {
    opacity: 1;
    transform: translateX(-50%) translateY(-4px);
  }

  /* -----------------------------------------
     NOSCRIPT
     ----------------------------------------- */
  .noscript-warning {
    padding: 8px 12px;
    background: #d84315;
    color: #fff;
    text-align: center;
    font-size: 14px;
  }

  /* -----------------------------------------
     MAP MARKER & ATTRIBUTION
     ----------------------------------------- */
  :where(.marker-cluster-small, .marker-cluster-medium, .marker-cluster-large) {
    background: transparent !important;
    box-shadow: none !important;
    border-radius: 999px !important;
  }

  :where(.marker-cluster-small, .marker-cluster-medium, .marker-cluster-large) > div {
    background-color: #8fbf5a !important; /* helleres Olive/Sage */
    border-radius: 999px !important;
    border: 2px solid #e8f2d8 !important; /* sehr heller Rand */
    color: #223015 !important;            /* dunkles Olive für Text */
    font-weight: 650 !important;
    font-family: inherit !important;

    width: 34px !important;
    height: 34px !important;
    margin: 0 !important;

    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    text-align: center !important;

    box-shadow: var(--elevation-sm) !important;
    box-sizing: border-box !important;
  }

  .marker-cluster span {
    display: block;
    font-size: 13px;
    line-height: 1;
  }

  .spot-marker {
    border-radius: var(--radius-pill, 999px);
  }

  .spot-marker-inner {
    width: 18px;
    height: 18px;
    border-radius: var(--radius-pill, 999px);
    background: radial-gradient(
      circle at 30% 20%,
      #f9fbf4 0,
      #c8e3a6 40%,
      #8fbf5a 100%
    );
    box-shadow:
      0 0 0 2px rgba(255, 255, 255, 0.9),
      0 6px 14px rgba(0, 0, 0, 0.55);
    position: relative;
  }

  .spot-marker--cluster {
    position: relative;
  }

  .spot-marker--cluster .spot-marker-inner {
    width: 28px;
    height: 28px;
  }

  .spot-marker-count {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 700;
    color: #223015;
  }

  .spot-marker-inner::after {
    content: "";
    position: absolute;
    inset: -5px;
    border-radius: inherit;
    background: radial-gradient(
      circle,
      rgba(143, 191, 90, 0.26),
      transparent 60%
    );
  }

  .pin-pop {
    animation: pin-pop 0.22s ease-out;
  }

  @keyframes pin-pop {
    0% { transform: scale(0.6); opacity: 0; }
    80% { transform: scale(1.08); opacity: 1; }
    100% { transform: scale(1); }
  }

  .leaflet-control-attribution {
    bottom: 4px !important;
    right: 12px !important;
    font-size: 10px;
  }

  .popup strong {
    font-size: 14px;
  }

  .popup small {
    font-size: 13px;
  }

  .popup-actions {
    margin-top: 4px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .popup-link {
    --shadow: var(--elevation-xs);

    font-size: 12px;
    font-weight: 650;
    padding: 4px 8px;
    border-radius: var(--radius-pill, 999px);

    background: var(--neutral-0);
    color: var(--text-strong, #1f2933);

    border: var(--stroke-2);
    box-shadow: var(--shadow);

    transition:
      background-color var(--dur, var(--dur-fallback)) var(--ease-out, var(--ease-out-fallback)),
      box-shadow var(--dur, var(--dur-fallback)) var(--ease-out, var(--ease-out-fallback)),
      transform var(--dur-fast, var(--dur-fast-fallback)) var(--ease-out, var(--ease-out-fallback));
  }

  .popup-link:active {
    --shadow: var(--elevation-xs);
    background: var(--neutral-2);
    transform: translateY(1px);
  }

  [data-theme="dark"] .popup-link {
    background: var(--neutral-0);
    color: var(--text-color, #e5e7eb);
    border: var(--stroke-2);
  }

  .radius-circle {
    stroke: var(--radius-circle-stroke);
    stroke-width: 2;
    fill: var(--radius-circle-fill);
  }

  /* -----------------------------------------
     Misc
     ----------------------------------------- */
  hr {
    border: none;
    border-bottom: 1px solid var(--fsm-divider-warm);
    margin: 16px 0;
  }

  [data-theme="dark"] hr {
    border-bottom-color: rgba(255, 255, 255, 0.10);
  }

  /* -----------------------------------------
     Onboarding hint
     ----------------------------------------- */
  .fsm-onboarding-hint {
    position: relative;
    margin: 0;
    padding: 10px 12px;
    border-radius: 16px;
    background: var(--card-bg, #ffffff);
    box-shadow: var(--elevation-xs);
    border: var(--border-soft);
    font-size: 14px;
    line-height: 1.5;
    color: var(--text-soft);
  }

  .fsm-onboarding-hint__text {
    margin: 0;
  }

  [data-theme="dark"] .fsm-onboarding-hint {
    background: var(--card-bg);
    color: var(--text-color, #e5e7eb);
    box-shadow: var(--elevation-sm);
    border: 1px solid rgba(255, 255, 255, 0.08);
  }

  .fsm-onboarding-hint__title {
    margin: 0 0 4px;
    font-size: 15px;
    font-weight: 700;
    color: var(--text-strong);
  }

  .fsm-onboarding-hint__list {
    margin: 0;
    padding-left: 1.25rem;
    font-size: 14px;
    line-height: 1.45;
    list-style-type: decimal;
  }

  .fsm-onboarding-hint__list li {
    margin: 0 0 2px;
  }

  .fsm-onboarding-hint__list li:last-child {
    margin-bottom: 0;
  }

  .fsm-onboarding-hint__close,
  .fsm-onboarding-hint-close {
    display: none !important;
  }

  .fsm-onboarding-hint--hidden {
    display: none;
  }

  /* -----------------------------------------
     Landscape warning
     ----------------------------------------- */
  .landscape-warning {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 70px;
    padding: 8px 12px;
    text-align: center;
    font-size: 14px;
    background: rgba(0, 0, 0, 0.78);
    color: #ffffff;
    z-index: 1400;
    display: none;
  }

  @media (orientation: landscape) and (max-width: 900px) {
    .landscape-warning {
      display: block;
    }
  }
}

/* =========================================
   UTILITIES — A11y helpers, Skip link, etc.
   ========================================= */
@layer utilities {
  .sr-only {
    position: absolute !important;
    width: 1px !important;
    height: 1px !important;
    padding: 0 !important;
    margin: -1px !important;
    overflow: hidden !important;
    clip: rect(0, 0, 0, 0) !important;
    white-space: nowrap !important;
    border: 0 !important;
  }

  .skip-link {
    position: absolute;
    left: -9999px;
    top: auto;
    width: 1px;
    height: 1px;
    overflow: hidden;
    white-space: nowrap;
    z-index: 3000;
  }

  .skip-link:focus,
  .skip-link:focus-visible {
    left: 12px;
    top: calc(env(safe-area-inset-top, 0px) + 12px);
    width: auto;
    height: auto;
    padding: 10px 14px;
    border-radius: 999px;
    background: rgba(255, 255, 255, 0.92);
    color: #111827;
    box-shadow: var(--elevation-lg);
    outline: none;
  }
}

/* =========================================
   OVERRIDES — Hover gating, color-mix, motion
   ========================================= */
@layer overrides {
  /* Hover only on devices that actually hover */
  @media (hover: hover) and (pointer: fine) {
    /* Primary CTA (.btn) uses system CTA tokens */
    .btn:hover {
      --shadow: var(--elevation-md);
      background-color: var(--cta-bg-hover, var(--accent-solid-dark, var(--accent-dark)));
    }

    @supports (background-color: color-mix(in oklab, white, black)) {
      .btn:hover {
        background-color: color-mix(
          in oklab,
          var(--cta-bg, var(--accent-solid, var(--accent))),
          black 8%
        );
      }
    }

    /* Tilla button hover must stay shell-colored */
    .btn-play-idea:hover {
      --shadow: var(--elevation-md);
      background-color: var(--tilla-shell-hover);
    }

    @supports (background-color: color-mix(in oklab, white, black)) {
      .btn-play-idea:hover {
        background-color: color-mix(in oklab, var(--tilla-shell), black 10%);
      }
    }

    .btn-secondary:hover {
      --shadow: var(--elevation-sm);
      background-color: var(--neutral-1);
    }

    .btn-ghost:hover {
      background-color: rgba(15, 23, 42, 0.05);
      border-color: rgba(148, 163, 184, 0.34);
      color: var(--text-strong, #111827);
    }

    [data-theme="dark"] .btn-ghost:hover {
      background-color: rgba(148, 163, 184, 0.14);
      border-color: rgba(148, 163, 184, 0.36);
    }

    .btn-icon:hover {
      --shadow: var(--elevation-md);
    }

    @supports (background-color: color-mix(in oklab, white, black)) {
      .btn-icon:hover {
        background-color: color-mix(in oklab, var(--header-icon-bg), white 8%);
      }
    }

    .app-menu-item:hover {
      --shadow: var(--elevation-md);
      background-color: var(--neutral-1);
    }

    .app-menu-lang-chip:hover {
      --shadow: var(--elevation-sm);
      background: var(--neutral-0);
    }

    :where(.mood-chip, .travel-chip, .compass-mode-chip, .tag-filter-chip, .btn-chip):hover {
      --shadow: var(--chip-shadow-hover);
      border-color: var(--chip-border-hover);
      box-shadow: var(--shadow);
    }

    .sidebar-section-close:hover {
      --shadow: var(--elevation-sm);
      background: var(--neutral-1);
      box-shadow: var(--shadow);
    }

    .spot-details-route-link:hover,
    .favorite-toggle:hover,
    .popup-link:hover {
      --shadow: var(--elevation-sm);
      background: var(--neutral-1);
      box-shadow: var(--shadow);
    }

    .daylog-entry:hover,
    .spot-card:hover {
      transform: translateY(-1px);
      box-shadow: var(--elevation-md);
    }
  }

  /* Ensure Tilla button active color */
  .btn-play-idea:active {
    background-color: var(--tilla-shell-active);
  }

  /* Prefers Reduced Motion */
  @media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
      scroll-behavior: auto !important;
      animation-duration: 0.001ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.001ms !important;
    }

    .pin-pop,
    .toast,
    .onboarding-slide {
      animation: none !important;
    }
  }

  /* Tilla bleibt animiert (bewusstes Produkt-Branding) */
  .tilla-sidebar-avatar img {
    animation: tilla-bob 3.5s ease-in-out infinite !important;
  }
}

/* =========================================================
   SAFETY OVERRIDES (UNLAYERED)
   - gewinnt gegen unlayered theme/button defaults
   - behebt den „es ändert nichts“-Fall zuverlässig
   ========================================================= */
#filter-section .sidebar-section-header > :last-child,
.sidebar-section--grow .sidebar-section-header > :last-child {
  width: auto !important;
  max-width: 100% !important;
  white-space: nowrap !important;
}

#filter-section .sidebar-section-header > :last-child,
#filter-section .sidebar-section-header > :last-child :where(button, a),
.sidebar-section--grow .sidebar-section-header > :last-child,
.sidebar-section--grow .sidebar-section-header > :last-child :where(button, a) {
  min-height: 28px !important;
  padding: 0 0.75rem !important;
  background: transparent !important;
  border: 1px solid transparent !important;
  box-shadow: none !important;
  line-height: 1 !important;
}